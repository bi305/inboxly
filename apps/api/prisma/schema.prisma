generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum WorkspaceRole {
  OWNER
  ADMIN
  MEMBER
}

enum BotVersionStatus {
  DRAFT
  PUBLISHED
}

enum ConversationStatus {
  OPEN
  CLOSED
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

enum ConnectionStatus {
  ACTIVE
  DISABLED
}

enum IdempotencyStatus {
  PENDING
  SENT
  FAILED
}

model User {
  id           String           @id @default(uuid())
  email        String           @unique
  passwordHash String
  name         String?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  memberships  WorkspaceMember[]
  refreshTokens RefreshToken[]
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  tokenHash String
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime @default(now())
  userAgent String?
  ip        String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Workspace {
  id          String            @id @default(uuid())
  name        String
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  members     WorkspaceMember[]
  bots        Bot[]
  connections WhatsAppConnection[]
  templates   Template[]
  contacts    Contact[]
  conversations Conversation[]
  auditLogs   AuditLog[]
}

model WorkspaceMember {
  id          String        @id @default(uuid())
  workspaceId String
  userId      String
  role        WorkspaceRole @default(MEMBER)
  createdAt   DateTime      @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@index([userId])
}

model WhatsAppConnection {
  id               String           @id @default(uuid())
  workspaceId      String
  botId            String?
  phoneNumberId    String
  businessId       String
  accessTokenEnc   String
  accessTokenIv    String
  accessTokenTag   String
  verifyTokenHash  String
  status           ConnectionStatus @default(ACTIVE)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  bot       Bot?      @relation(fields: [botId], references: [id], onDelete: SetNull)
  webhookEvents WebhookEvent[]

  @@index([workspaceId])
  @@unique([workspaceId, phoneNumberId])
}

model Bot {
  id          String       @id @default(uuid())
  workspaceId String
  name        String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  versions    BotVersion[]
  conversations Conversation[]
  connections WhatsAppConnection[]

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
}

model BotVersion {
  id        String           @id @default(uuid())
  botId     String
  version   Int
  status    BotVersionStatus @default(DRAFT)
  flow      Json
  createdAt DateTime         @default(now())

  bot Bot @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@unique([botId, version])
}

model Contact {
  id          String   @id @default(uuid())
  workspaceId String
  phoneNumber String
  displayName String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  conversations Conversation[]

  @@unique([workspaceId, phoneNumber])
  @@index([workspaceId])
}

model Conversation {
  id          String             @id @default(uuid())
  workspaceId String
  contactId   String
  botId       String
  status      ConversationStatus @default(OPEN)
  lastInteractionAt DateTime? 
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  contact   Contact   @relation(fields: [contactId], references: [id], onDelete: Cascade)
  bot       Bot       @relation(fields: [botId], references: [id], onDelete: Cascade)
  messages  Message[]
  state     ConversationState?

  @@unique([workspaceId, contactId, botId])
  @@index([workspaceId])
}

model ConversationState {
  id             String   @id @default(uuid())
  conversationId String   @unique
  currentNodeId  String?
  variables      Json
  updatedAt      DateTime @updatedAt

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
}

model Message {
  id             String          @id @default(uuid())
  conversationId String
  direction      MessageDirection
  messageId      String?
  idempotencyKey String?
  payload        Json
  createdAt      DateTime        @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
}

model WebhookEvent {
  id            String   @id @default(uuid())
  workspaceId   String
  connectionId  String
  eventId       String
  payload       Json
  receivedAt    DateTime @default(now())

  connection WhatsAppConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@unique([connectionId, eventId])
  @@index([workspaceId])
}

model IdempotencyKey {
  id          String            @id @default(uuid())
  workspaceId String
  key         String
  status      IdempotencyStatus @default(PENDING)
  createdAt   DateTime          @default(now())

  @@unique([workspaceId, key])
  @@index([workspaceId])
}

model AuditLog {
  id          String   @id @default(uuid())
  workspaceId String
  actorId     String?
  action      String
  targetType  String
  targetId    String?
  metadata    Json?
  createdAt   DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
}

model Template {
  id          String   @id @default(uuid())
  workspaceId String
  name        String
  language    String
  createdAt   DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, name, language])
  @@index([workspaceId])
}
